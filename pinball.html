<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>無限リフレクト・ピンボール — 3 Balls & BG Keep-Alive (Mobile Ready)</title>
<style>
html,body{
  height:100%;margin:0;display:flex;flex-direction:column;justify-content:center;align-items:center;
  background:#111;color:#eee;font-family:"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;
  -webkit-user-select:none;user-select:none;
}
#hud{
  position:fixed;top:0;left:0;width:100%;padding:.4rem 0;
  text-align:center;font-size:clamp(1.6rem,5vw,2.4rem);
  font-weight:bold;letter-spacing:.05em;
  background:#000a;pointer-events:none;z-index:10;
}
/* ===== ゲーム領域 ===== */
#container{
  margin-top:3.2rem; /* HUD 分 */
  display:flex;flex-direction:column;align-items:center;
  width:90vw;max-width:400px;
}
#gameCanvas{
  width:100%;height:auto; /* 縦横比維持で縮小 */
  background:#222;border:4px solid #555;border-radius:8px;
  box-shadow:0 0 16px rgba(0,0,0,.6);
  touch-action:none; /* スクロール無効化 */
}
/* ===== モバイル専用リセット ===== */
#resetBtn{
  margin-top:.6rem;padding:.4rem 1.2rem;font-size:1rem;font-weight:bold;
  color:#eee;background:#444;border:none;border-radius:6px;display:inline-flex;align-items:center;gap:.3rem;
}
#resetBtn:active{transform:scale(.96);}
@media (min-width:768px){#resetBtn{display:none;}}

p{margin:.5rem 0 0;font-size:.85rem;opacity:.8;}
</style>
</head>
<body>
<div id="hud">Score: <span id="score">0</span></div>
<div id="container">
  <canvas id="gameCanvas" width="400" height="600" tabindex="0" aria-label="ピンボールゲーム"></canvas>
  <button id="resetBtn" aria-label="ボールをリセット">🔄 リセット</button>
  <p>PC: R キー / Mobile: リセットボタン</p>
</div>

<script>
/* =========================================================
   3-Ball Pinball  +  Background Keep-Alive (Mobile Ready)
   ========================================================= */
(()=>{
/* == 基本設定 == */
const canvas = document.getElementById("gameCanvas"),
      ctx    = canvas.getContext("2d"),
      W      = 400,
      H      = 600;

const BAR_H       = 20;
const SPEED       = 50;
const BUMPER_REST = 1.05;
const BALLS_TOTAL = 1;   // ← ボール数

/* == HUD == */
let score = 0;
const scoreEl = document.getElementById("score");
const addScore = p => { score += p; };

/* == ボール生成 == */
function createBall(){
  const angle = Math.random()*Math.PI*2;
  return {
    x: W/2, y: H/2, r: 8,
    vx: Math.cos(angle)*SPEED,
    vy: Math.sin(angle)*SPEED,
    trail: []
  };
}
const balls = Array.from({length: BALLS_TOTAL}, createBall);
function resetBalls(){ balls.forEach((_,i)=> balls[i] = createBall()); }

/* == バンパー == */
const bumpers=[
  {x: W/2 ,  y: H*0.30 , r:28, score:120},
  {x: W*0.25,y: H*0.45 , r:22, score:60},
  {x: W*0.50,y: H*0.48 , r:22, score:60},
  {x: W*0.75,y: H*0.45 , r:22, score:60},
  {x: W*0.20,y: H*0.60 , r:18, score:40},
  {x: W*0.40,y: H*0.65 , r:18, score:40},
  {x: W*0.60,y: H*0.65 , r:18, score:40},
  {x: W*0.80,y: H*0.60 , r:18, score:40}
];

/* == 共通ヘルパ == */
function randomReflectFrom(b, nx, ny){
  const base = Math.atan2(ny, nx);
  const spread = (Math.PI/180)*60;
  const ang = base + (Math.random()*2-1)*spread;
  b.vx = Math.cos(ang)*SPEED;
  b.vy = Math.sin(ang)*SPEED;
}
function normalizeSpeed(b){
  const m = Math.hypot(b.vx,b.vy);
  b.vx = b.vx/m*SPEED;
  b.vy = b.vy/m*SPEED;
}

/* == 衝突処理 == */
function collideWall(b){
  if(b.x - b.r < 0){ b.x = b.r;             randomReflectFrom(b, 1, 0); }
  if(b.x + b.r > W){ b.x = W - b.r;         randomReflectFrom(b,-1, 0); }
  if(b.y - b.r < 0){ b.y = b.r;             randomReflectFrom(b, 0, 1); }
  if(b.y + b.r > H - BAR_H){
    b.y = H - BAR_H - b.r;                  randomReflectFrom(b, 0,-1);
  }
}
function collideBumper(b){
  bumpers.forEach(p=>{
    const dx=b.x-p.x, dy=b.y-p.y,
          d = Math.hypot(dx,dy),
          min=b.r+p.r;
    if(d<min){
      const nx=dx/d, ny=dy/d;
      b.x = p.x + nx*min;
      b.y = p.y + ny*min;
      const dot = b.vx*nx + b.vy*ny;
      b.vx = (b.vx - 2*dot*nx)*BUMPER_REST;
      b.vy = (b.vy - 2*dot*ny)*BUMPER_REST;
      normalizeSpeed(b);
      addScore(p.score);
    }
  });
}

/* == 入力 == */
window.addEventListener("keydown",e=>{ if(e.code==="KeyR") resetBalls(); });
const resetBtn=document.getElementById("resetBtn");
resetBtn.addEventListener("click", resetBalls);

/* == 物理 & 描画 == */
function physics(){
  balls.forEach(b=>{
    b.x += b.vx; b.y += b.vy;
    collideWall(b);
    collideBumper(b);
    normalizeSpeed(b);
    b.trail.push({x:b.x,y:b.y});
    if(b.trail.length>25) b.trail.shift();
  });
}
function render(){
  ctx.clearRect(0,0,W,H);
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"#222"); g.addColorStop(1,"#111");
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ctx.fillStyle="#444"; ctx.fillRect(0,H-BAR_H,W,BAR_H);
  ctx.fillStyle="#666";
  bumpers.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();});
  balls.forEach(b=>{
    b.trail.forEach((t,i)=>{
      const a=i/b.trail.length;
      ctx.fillStyle=`rgba(255,218,98,${a*0.6})`;
      ctx.beginPath();ctx.arc(t.x,t.y,b.r*(0.5+a*0.6),0,Math.PI*2);ctx.fill();
    });
    ctx.fillStyle="#ffda62";
    ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();
  });
  scoreEl.textContent=score;
}

/* == メインループ (背景対応) == */
let rafId=null, intervalId=null;
function tick(){ physics(); render(); }
function rafLoop(){ tick(); rafId=requestAnimationFrame(rafLoop); }

function handleVisibility(){
  if(document.hidden){
    cancelAnimationFrame(rafId);
    intervalId = setInterval(tick, 1000/60);
  }else{
    clearInterval(intervalId);
    rafId = requestAnimationFrame(rafLoop);
  }
}
document.addEventListener("visibilitychange", handleVisibility);

/* == 起動 == */
rafId = requestAnimationFrame(rafLoop);
canvas.focus();
})();
</script>
</body>
</html>
